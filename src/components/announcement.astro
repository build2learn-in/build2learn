---
import { getCollection } from 'astro:content';

const events = await getCollection('event');

// Get all events sorted by date
// Client-side JavaScript will handle showing/hiding based on current date
const sortedEvents = events
  .map((event: any) => ({
    ...event,
    eventDate: new Date(event.data.eventDate),
  }))
  .sort((a: any, b: any) => a.eventDate.getTime() - b.eventDate.getTime());

// Get the latest event (most recent by event number)
const upcomingEvent = sortedEvents[sortedEvents.length - 1];

const formatEventDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
  });
};
---

{
  upcomingEvent && (
    <section
      id="event-banner"
      data-event-date={upcomingEvent.eventDate.toISOString()}
      class="relative overflow-hidden py-6 px-4 sm:px-6 lg:px-8 bg-gradient-to-r from-blue-500 via-blue-600 to-indigo-600"
      style="display: none;"
    >
      {/* Simplified background pattern */}
      <div class="absolute inset-0 opacity-5">
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent" />
      </div>

      <div class="relative container mx-auto">
        <div class="flex flex-col lg:flex-row items-center justify-between gap-6">
          {/* Main content */}
          <div class="text-center lg:text-left">
            <div class="inline-flex items-center px-4 py-2 rounded-full bg-white/20 backdrop-blur-sm border border-white/30 mb-4">
              <div class="w-3 h-3 bg-white rounded-full animate-pulse mr-3" />
              <span
                id="event-status"
                class="text-white font-semibold text-sm tracking-wide uppercase"
              >
                UPCOMING EVENT
              </span>
            </div>

            <h2 class="text-2xl lg:text-3xl font-bold text-white mb-2 leading-tight">
              {upcomingEvent.data.title} Meetup
            </h2>

            <div class="flex flex-col sm:flex-row sm:items-center gap-4 text-white/90">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="font-medium">
                  {formatEventDate(upcomingEvent.eventDate)}
                </span>
              </div>

              <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="font-medium">
                  {upcomingEvent.data.eventTime} IST
                </span>
              </div>

              <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="font-medium">{upcomingEvent.data.venue}</span>
              </div>
            </div>
          </div>

          {/* Registration Button */}
          {upcomingEvent.data.registration_link && (
            <div class="flex-shrink-0">
              <a
                href={upcomingEvent.data.registration_link}
                target="_blank"
                rel="noopener noreferrer"
                id="register-button"
                class="inline-flex items-center px-6 py-3 rounded-lg font-bold shadow-lg transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white bg-white text-blue-600 hover:text-blue-700"
              >
                <span>Register Now</span>
                <svg
                  class="w-5 h-5 ml-2 -mr-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 8l4 4m0 0l-4 4m4-4H3"
                  />
                </svg>
              </a>
            </div>
          )}
        </div>
      </div>
    </section>
  )
}

<script>
  // This script runs in the browser with the REAL current date
  document.addEventListener('DOMContentLoaded', () => {
    const banner = document.getElementById('event-banner');
    if (!banner) return;

    const eventDateStr = banner.getAttribute('data-event-date');
    if (!eventDateStr) return;

    const eventDate = new Date(eventDateStr);

    // Get current date in IST timezone
    const now = new Date();
    const istTimeString = now.toLocaleString('en-US', {
      timeZone: 'Asia/Kolkata',
    });
    const currentDateIST = new Date(istTimeString);

    // Create date-only versions for comparison (ignore time)
    const eventDateOnly = new Date(
      eventDate.getFullYear(),
      eventDate.getMonth(),
      eventDate.getDate()
    );
    const currentDateOnly = new Date(
      currentDateIST.getFullYear(),
      currentDateIST.getMonth(),
      currentDateIST.getDate()
    );

    // Show banner only if event is today or in the future
    if (eventDateOnly.getTime() >= currentDateOnly.getTime()) {
      banner.style.display = 'block';

      // Check if event is happening today
      if (eventDateOnly.getTime() === currentDateOnly.getTime()) {
        const statusSpan = document.getElementById('event-status');
        if (statusSpan) {
          statusSpan.textContent = 'HAPPENING NOW';
        }
        // Change to green gradient for today's event
        banner.classList.remove(
          'bg-gradient-to-r',
          'from-blue-500',
          'via-blue-600',
          'to-indigo-600'
        );
        banner.classList.add(
          'bg-gradient-to-r',
          'from-emerald-500',
          'via-green-500',
          'to-teal-500'
        );
        // Change register button to green color
        const registerButton = document.getElementById('register-button');
        if (registerButton) {
          registerButton.classList.remove(
            'text-blue-600',
            'hover:text-blue-700'
          );
          registerButton.classList.add(
            'text-emerald-600',
            'hover:text-emerald-700'
          );
        }
      }
    }
    // If event has passed, banner stays hidden (display: none)
  });
</script>
