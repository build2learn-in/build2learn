---
import { getCollection } from 'astro:content';

const events = await getCollection('event');
const currentDate = new Date();

const currentEvent = events
  .map((event: any) => ({
    ...event,
    eventDate: new Date(event.data.eventDate),
  }))
  .filter((event: any) => {
    const eventDate = event.eventDate;
    const eventStartTime = new Date(eventDate);
    const eventEndTime = new Date(eventDate);
    
    // Parse event time (assuming format like "6:00 PM" or "18:00")
    const timeStr = event.data.eventTime;
    const [time, period] = timeStr.split(' ');
    const [hours, minutes] = time.split(':');
    
    let eventHour = parseInt(hours);
    if (period === 'PM' && eventHour !== 12) {
      eventHour += 12;
    } else if (period === 'AM' && eventHour === 12) {
      eventHour = 0;
    }
    
    eventStartTime.setHours(eventHour, parseInt(minutes), 0, 0);
    eventEndTime.setHours(eventHour + 2, parseInt(minutes), 0, 0); // Assuming 2-hour events
    
    return currentDate >= eventStartTime && currentDate <= eventEndTime;
  })
  .sort((a: any, b: any) => a.eventDate.getTime() - b.eventDate.getTime())[0];

const formatEventDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
  });
};
---

{
  currentEvent && (
    <section class="bg-green-100 text-gray-900 py-4 px-4 sm:px-6 lg:px-8 border-b border-green-300">
      <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4 text-center md:text-left">
        <div>
          <p class="text-lg font-semibold">
            🔴 HAPPENING NOW: {currentEvent.data.title} Meetup -{' '}
            <span class="text-primary font-bold">
              {formatEventDate(currentEvent.eventDate)}
            </span>
          </p>
          <p class="text-sm text-gray-700">
            ⏰ {currentEvent.data.eventTime} IST | 📍{' '}
            {currentEvent.data.venue}
          </p>
        </div>
        {currentEvent.data.registration_link && (
          <a
            href={currentEvent.data.registration_link}
            target="_blank"
            class="inline-block bg-green-600 text-white font-semibold px-6 py-2 rounded-lg shadow-md hover:bg-green-700 transition"
          >
            Join Now →
          </a>
        )}
      </div>
    </section>
  )
}
